name: Publish Snapshots

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_detection:
        description: 'Skip change detection and publish all modules'
        required: false
        default: false
        type: boolean

jobs:
  # Validate and bundle OpenAPI spec first
  spec-validation:
    name: Validate OpenAPI Spec
    if: >-
      github.event_name == 'workflow_dispatch' ||
      !contains(github.event.head_commit.message, '[release]')
    runs-on: ubuntu-latest
    outputs:
      snapshot_version: ${{ steps.version.outputs.snapshot_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Calculate snapshot version
        id: version
        run: |
          API_VERSION=$(grep -E '^\s*version:' epistola-api.yaml | head -1 | sed -E 's/.*version:\s*["'"'"']?([0-9]+\.[0-9]+)\.[0-9]+["'"'"']?.*/\1/')
          SNAPSHOT_VERSION="${API_VERSION}-SNAPSHOT"
          echo "snapshot_version=${SNAPSHOT_VERSION}" >> $GITHUB_OUTPUT
          echo "Snapshot version: ${SNAPSHOT_VERSION}"

      - name: Validate OpenAPI spec
        run: npx @redocly/cli lint epistola-api.yaml

      - name: Bundle OpenAPI spec
        run: npx @redocly/cli bundle epistola-api.yaml -o openapi.yaml

      - name: Inject snapshot version into bundled spec
        run: |
          SNAPSHOT_VERSION="${{ steps.version.outputs.snapshot_version }}"
          sed -i "0,/^\s*version:/{s/^\(\s*version:\s*\).*/\1\"${SNAPSHOT_VERSION}\"/}" openapi.yaml
          echo "Set openapi.yaml version to ${SNAPSHOT_VERSION}"
          grep 'version:' openapi.yaml | head -1

      - name: Upload bundled spec
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.yaml
          retention-days: 1

  # Detect which modules have changes
  detect-changes:
    name: Detect Changes
    if: >-
      github.event_name == 'workflow_dispatch' ||
      !contains(github.event.head_commit.message, '[release]')
    runs-on: ubuntu-latest
    outputs:
      spec: ${{ steps.filter.outputs.spec }}
      client: ${{ steps.filter.outputs.client }}
      server: ${{ steps.filter.outputs.server }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            spec:
              - 'epistola-api.yaml'
              - 'spec/**'
            client:
              - 'epistola-api.yaml'
              - 'spec/**'
              - 'client-kotlin-spring-restclient/**'
            server:
              - 'epistola-api.yaml'
              - 'spec/**'
              - 'server-kotlin-springboot4/**'

  # Build and test modules in parallel before publishing.
  # This prevents half-releases where one module publishes but the other fails.
  build:
    name: Build ${{ matrix.module }}
    needs: [spec-validation, detect-changes]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - module: client-kotlin-spring-restclient
            filter: client
          - module: server-kotlin-springboot4
            filter: server
    steps:
      - name: Check if should run
        id: should_run
        env:
          CHANGED: ${{ needs.detect-changes.outputs[matrix.filter] }}
          SKIP_DETECTION: ${{ inputs.skip_detection }}
        run: |
          if [ "$CHANGED" == "true" ] || [ "$SKIP_DETECTION" == "true" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.should_run.outputs.enabled == 'true'
        uses: actions/checkout@v6

      - name: Download bundled spec
        if: steps.should_run.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec

      - name: Setup tools with mise
        if: steps.should_run.outputs.enabled == 'true'
        uses: jdx/mise-action@v3

      - name: Setup Gradle cache
        if: steps.should_run.outputs.enabled == 'true'
        uses: gradle/actions/setup-gradle@v5

      - name: Build and test
        if: steps.should_run.outputs.enabled == 'true'
        working-directory: ${{ matrix.module }}
        run: ./gradlew build -Pversion=${{ needs.spec-validation.outputs.snapshot_version }}

  # Only publish after all builds succeed
  publish:
    name: Publish ${{ matrix.artifact_id }} Snapshot
    needs: [spec-validation, detect-changes, build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - module: client-kotlin-spring-restclient
            artifact_id: client-spring3-restclient
            filter: client
          - module: server-kotlin-springboot4
            artifact_id: server-kotlin-springboot4
            filter: server
    steps:
      - name: Check if should run
        id: should_run
        env:
          CHANGED: ${{ needs.detect-changes.outputs[matrix.filter] }}
          SKIP_DETECTION: ${{ inputs.skip_detection }}
        run: |
          if [ "$CHANGED" == "true" ] || [ "$SKIP_DETECTION" == "true" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.should_run.outputs.enabled == 'true'
        uses: actions/checkout@v6

      - name: Download bundled spec
        if: steps.should_run.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec

      - name: Setup tools with mise
        if: steps.should_run.outputs.enabled == 'true'
        uses: jdx/mise-action@v3

      - name: Setup Gradle cache
        if: steps.should_run.outputs.enabled == 'true'
        uses: gradle/actions/setup-gradle@v5

      - name: Publish snapshot to Maven Central
        if: steps.should_run.outputs.enabled == 'true'
        working-directory: ${{ matrix.module }}
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSPHRASE }}
        run: ./gradlew publishToMavenCentral -Pversion=${{ needs.spec-validation.outputs.snapshot_version }}

  # Publish mock server snapshot when spec changes
  mock-server:
    name: Publish Mock Server Snapshot
    needs: [spec-validation, detect-changes]
    if: needs.detect-changes.outputs.spec == 'true' || inputs.skip_detection == true
    uses: ./.github/workflows/mock-server.yml
    with:
      version: ${{ needs.spec-validation.outputs.snapshot_version }}
    permissions:
      contents: read
      packages: write
