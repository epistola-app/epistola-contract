name: Build and Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, labeled]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup tools with mise
        uses: jdx/mise-action@v3

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v5

      - name: Build and test
        run: gradle build

      - name: Generate coverage report
        run: gradle koverXmlReport

      - name: Generate coverage badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: coverage
        run: |
          # Parse coverage percentage from Kover XML report
          REPORT_FILE="build/reports/kover/report.xml"
          if [ -f "$REPORT_FILE" ]; then
            # Extract instruction coverage from the summary counter
            COVERED=$(grep -o 'type="INSTRUCTION"[^/]*' "$REPORT_FILE" | tail -1 | grep -oP 'covered="\K[0-9]+')
            MISSED=$(grep -o 'type="INSTRUCTION"[^/]*' "$REPORT_FILE" | tail -1 | grep -oP 'missed="\K[0-9]+')

            if [ -n "$COVERED" ] && [ -n "$MISSED" ]; then
              TOTAL=$((COVERED + MISSED))
              if [ "$TOTAL" -gt 0 ]; then
                PERCENTAGE=$((COVERED * 100 / TOTAL))
              else
                PERCENTAGE=0
              fi
            else
              PERCENTAGE=0
            fi
          else
            PERCENTAGE=0
          fi

          echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT

          # Determine badge color based on coverage
          if [ "$PERCENTAGE" -ge 80 ]; then
            COLOR="brightgreen"
          elif [ "$PERCENTAGE" -ge 60 ]; then
            COLOR="green"
          elif [ "$PERCENTAGE" -ge 40 ]; then
            COLOR="yellow"
          elif [ "$PERCENTAGE" -ge 20 ]; then
            COLOR="orange"
          else
            COLOR="red"
          fi

          # Create shields.io endpoint JSON
          mkdir -p .github/badges
          cat > .github/badges/coverage.json << EOF
          {"schemaVersion":1,"label":"coverage","message":"${PERCENTAGE}%","color":"${COLOR}"}
          EOF

          echo "color=$COLOR" >> $GITHUB_OUTPUT

      - name: Commit coverage badge
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/badges/coverage.json
          if git diff --staged --quiet; then
            echo "No changes to coverage badge"
          else
            git commit -m "chore: update coverage badge [skip ci]"
            git push
          fi

      - name: Generate SBOM
        run: gradle :app:generateSbom

      - name: Scan SBOM for vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'sbom'
          scan-ref: 'app/build/sbom/bom.json'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'
          output: 'vulnerability-report.txt'

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: sbom
          path: app/build/sbom/bom.json
          retention-days: 7

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: vulnerability-report
          path: vulnerability-report.txt
          retention-days: 7

  # Uncomment to enable Docker image builds
  # docker:
  #   name: Build and Push Docker Image
  #   runs-on: ubuntu-latest
  #   needs: build
  #   if: github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'publish')
  #   permissions:
  #     contents: write
  #     packages: write
  #     id-token: write
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v6
  #       with:
  #         fetch-depth: 0
  #
  #     - name: Setup tools with mise
  #       uses: jdx/mise-action@v3
  #
  #     - name: Setup Gradle cache
  #       uses: gradle/actions/setup-gradle@v5
  #
  #     - name: Log in to Container Registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ${{ env.REGISTRY }}
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}
  #
  #     - name: Install Cosign
  #       uses: sigstore/cosign-installer@v3
  #
  #     - name: Build Docker image
  #       run: gradle :app:bootBuildImage
  #
  #     # Add tagging and push steps as needed
