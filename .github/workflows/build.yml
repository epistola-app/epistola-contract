name: Build and Test

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, labeled]

jobs:
  # OpenAPI spec validation and bundling
  spec-validation:
    name: Validate OpenAPI Spec
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Validate OpenAPI spec
        run: npx @redocly/cli lint epistola-api.yaml

      - name: Bundle OpenAPI spec
        run: npx @redocly/cli bundle epistola-api.yaml -o openapi.yaml

      - name: Upload bundled spec
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.yaml
          retention-days: 1

  # Kotlin Spring RestClient build
  kotlin-client:
    name: Kotlin Client (Spring RestClient)
    needs: spec-validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client-kotlin-spring-restclient
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download bundled spec
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec

      - name: Setup tools with mise
        uses: jdx/mise-action@v3

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v5

      - name: Build and test
        run: ./gradlew build

  # Kotlin server stubs build
  kotlin-server:
    name: Kotlin Server (Spring)
    needs: spec-validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server-kotlin-springboot4
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download bundled spec
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec

      - name: Setup tools with mise
        uses: jdx/mise-action@v3

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v5

      - name: Build and test
        run: ./gradlew build

