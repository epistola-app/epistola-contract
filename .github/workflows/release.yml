name: Release to Maven Central

on:
  # Auto-release when a commit on main contains [release], or any push to release branches
  push:
    branches:
      - main
      - 'release/**'
  # Manual release
  workflow_dispatch:
    inputs:
      module:
        description: 'Module to release'
        required: true
        type: choice
        options:
          - both
          - client-kotlin-spring-restclient
          - server-kotlin-springboot4

jobs:
  # Validate and bundle spec
  validate-and-bundle:
    name: Validate and bundle spec
    if: >-
      contains(github.event.head_commit.message, '[release]') ||
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/heads/release/')
    runs-on: ubuntu-latest
    outputs:
      api_version: ${{ steps.validate.outputs.api_version }}
      spec_version: ${{ steps.validate.outputs.spec_version }}
      release_version: ${{ steps.version.outputs.release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Read spec version
        id: validate
        run: |
          # Read full spec version (e.g., 1.0.0)
          SPEC_VERSION=$(grep -E '^\s*version:' epistola-api.yaml | head -1 | sed -E 's/.*version:\s*["'"'"']?([0-9]+\.[0-9]+\.[0-9]+)["'"'"']?.*/\1/')
          echo "spec_version=${SPEC_VERSION}" >> $GITHUB_OUTPUT
          echo "Full spec version: ${SPEC_VERSION}"

          # Extract API version (major.minor)
          API_VERSION=$(echo "$SPEC_VERSION" | sed -E 's/([0-9]+\.[0-9]+)\.[0-9]+/\1/')
          echo "api_version=${API_VERSION}" >> $GITHUB_OUTPUT
          echo "API version: ${API_VERSION}"

          # For release/* branches, validate version matches
          BRANCH="${GITHUB_REF#refs/heads/}"
          if [[ "$BRANCH" == release/* ]]; then
            BRANCH_VERSION="${BRANCH#release/}"
            if [[ "$BRANCH_VERSION" != "$API_VERSION" ]]; then
              echo "::error::Branch version ($BRANCH_VERSION) does not match spec version ($API_VERSION)"
              echo "::error::Release branch 'release/$BRANCH_VERSION' must have spec version '$BRANCH_VERSION.x'"
              exit 1
            fi
            echo "Branch version matches spec version"
          fi

      - name: Calculate release version
        id: version
        run: |
          API_VERSION="${{ steps.validate.outputs.api_version }}"

          # Find the highest patch version among all release tags for this API version
          LATEST_PATCH=-1
          for tag in $(git tag -l "*-v${API_VERSION}.*"); do
            PATCH=$(echo "$tag" | sed -E 's/.*-v[0-9]+\.[0-9]+\.([0-9]+)/\1/')
            if [ "$PATCH" -gt "$LATEST_PATCH" ] 2>/dev/null; then
              LATEST_PATCH=$PATCH
            fi
          done

          NEXT_PATCH=$((LATEST_PATCH + 1))
          RELEASE_VERSION="${API_VERSION}.${NEXT_PATCH}"
          echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "Release version: ${RELEASE_VERSION}"

      - name: Validate OpenAPI spec
        run: npx @redocly/cli lint epistola-api.yaml

      - name: Bundle OpenAPI spec
        run: npx @redocly/cli bundle epistola-api.yaml -o openapi.yaml

      - name: Inject release version into bundled spec
        run: |
          RELEASE_VERSION="${{ steps.version.outputs.release_version }}"
          sed -i "0,/^\s*version:/{s/^\(\s*version:\s*\).*/\1\"${RELEASE_VERSION}\"/}" openapi.yaml
          echo "Set openapi.yaml version to ${RELEASE_VERSION}"
          grep 'version:' openapi.yaml | head -1

      - name: Upload bundled spec
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.yaml
          retention-days: 1

  # Build and test all modules before publishing anything.
  # This prevents half-releases where one module publishes but the other fails.
  build:
    needs: validate-and-bundle
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - module: client-kotlin-spring-restclient
          - module: server-kotlin-springboot4
    steps:
      - name: Check if should run
        id: should_run
        run: |
          # For push events (auto-release), always build both
          # For workflow_dispatch, check the input
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            MODULE_INPUT="${{ inputs.module }}"
            if [ "$MODULE_INPUT" == "both" ] || [ "$MODULE_INPUT" == "${{ matrix.module }}" ]; then
              echo "enabled=true" >> $GITHUB_OUTPUT
            else
              echo "enabled=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Checkout
        if: steps.should_run.outputs.enabled == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download bundled spec
        if: steps.should_run.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec

      - name: Setup tools with mise
        if: steps.should_run.outputs.enabled == 'true'
        uses: jdx/mise-action@v3

      - name: Setup Gradle cache
        if: steps.should_run.outputs.enabled == 'true'
        uses: gradle/actions/setup-gradle@v5

      - name: Build and test
        if: steps.should_run.outputs.enabled == 'true'
        working-directory: ${{ matrix.module }}
        run: ./gradlew build -Pversion=${{ needs.validate-and-bundle.outputs.release_version }}

  # Only publish after ALL builds succeed â€” no more half-releases
  publish:
    needs: [validate-and-bundle, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - module: client-kotlin-spring-restclient
            artifact_id: client-spring3-restclient
          - module: server-kotlin-springboot4
            artifact_id: server-kotlin-springboot4
    steps:
      - name: Check if should run
        id: should_run
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            MODULE_INPUT="${{ inputs.module }}"
            if [ "$MODULE_INPUT" == "both" ] || [ "$MODULE_INPUT" == "${{ matrix.module }}" ]; then
              echo "enabled=true" >> $GITHUB_OUTPUT
            else
              echo "enabled=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Checkout
        if: steps.should_run.outputs.enabled == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download bundled spec
        if: steps.should_run.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec

      - name: Setup tools with mise
        if: steps.should_run.outputs.enabled == 'true'
        uses: jdx/mise-action@v3

      - name: Setup Gradle cache
        if: steps.should_run.outputs.enabled == 'true'
        uses: gradle/actions/setup-gradle@v5

      - name: Publish to Maven Central
        if: steps.should_run.outputs.enabled == 'true'
        working-directory: ${{ matrix.module }}
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSPHRASE }}
        run: ./gradlew publishToMavenCentral -Pversion=${{ needs.validate-and-bundle.outputs.release_version }}

      - name: Create GitHub Release
        if: steps.should_run.outputs.enabled == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.artifact_id }}-v${{ needs.validate-and-bundle.outputs.release_version }}
          name: ${{ matrix.artifact_id }} v${{ needs.validate-and-bundle.outputs.release_version }}
          files: openapi.yaml
          body: |
            ## ${{ matrix.artifact_id }} v${{ needs.validate-and-bundle.outputs.release_version }}

            ### Maven Coordinates
            ```xml
            <dependency>
                <groupId>app.epistola.contract</groupId>
                <artifactId>${{ matrix.artifact_id }}</artifactId>
                <version>${{ needs.validate-and-bundle.outputs.release_version }}</version>
            </dependency>
            ```

            ### Gradle (Kotlin DSL)
            ```kotlin
            implementation("app.epistola.contract:${{ matrix.artifact_id }}:${{ needs.validate-and-bundle.outputs.release_version }}")
            ```

            ### OpenAPI Spec
            The bundled OpenAPI specification is attached as `openapi.yaml`.
          draft: false
          prerelease: false
          generate_release_notes: true

  # Publish mock server after successful release
  mock-server:
    name: Publish Mock Server
    needs: [validate-and-bundle, publish]
    uses: ./.github/workflows/mock-server.yml
    with:
      version: ${{ needs.validate-and-bundle.outputs.release_version }}
    permissions:
      contents: read
      packages: write
