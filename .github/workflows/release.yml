name: Release to Maven Central

on:
  # Auto-release on push to release branches
  push:
    branches:
      - 'release/**'
  # Manual release from any allowed branch
  workflow_dispatch:
    inputs:
      module:
        description: 'Module to release'
        required: true
        type: choice
        options:
          - both
          - client-kotlin-spring-restclient
          - server-kotlin-springboot4

jobs:
  # Validate branch and bundle spec
  validate-and-bundle:
    name: Validate branch and bundle spec
    runs-on: ubuntu-latest
    outputs:
      api_version: ${{ steps.validate.outputs.api_version }}
      is_release_branch: ${{ steps.validate.outputs.is_release_branch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Validate branch matches spec version
        id: validate
        run: |
          # Read API version from spec
          API_VERSION=$(grep -E '^\s*version:' epistola-api.yaml | head -1 | sed -E 's/.*version:\s*["'"'"']?([0-9]+\.[0-9]+)\.[0-9]+["'"'"']?.*/\1/')
          echo "api_version=${API_VERSION}" >> $GITHUB_OUTPUT
          echo "Spec API version: ${API_VERSION}"

          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Branch: ${BRANCH}"

          # For release/* branches, validate version matches
          if [[ "$BRANCH" == release/* ]]; then
            echo "is_release_branch=true" >> $GITHUB_OUTPUT
            BRANCH_VERSION="${BRANCH#release/}"
            if [[ "$BRANCH_VERSION" != "$API_VERSION" ]]; then
              echo "::error::Branch version ($BRANCH_VERSION) does not match spec version ($API_VERSION)"
              echo "::error::Release branch 'release/$BRANCH_VERSION' must have spec version '$BRANCH_VERSION.x'"
              exit 1
            fi
            echo "Branch version matches spec version"
          else
            echo "is_release_branch=false" >> $GITHUB_OUTPUT
            echo "Main branch - any version allowed"
          fi

      - name: Validate OpenAPI spec
        run: npx @redocly/cli lint epistola-api.yaml

      - name: Bundle OpenAPI spec
        run: npx @redocly/cli bundle epistola-api.yaml -o openapi.yaml

      - name: Upload bundled spec
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: openapi.yaml
          retention-days: 1

  release:
    name: Release ${{ matrix.artifact_id }}
    needs: validate-and-bundle
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - module: client-kotlin-spring-restclient
            artifact_id: client-spring3-restclient
          - module: server-kotlin-springboot4
            artifact_id: server-kotlin-springboot4
    steps:
      - name: Check if should run
        id: should_run
        run: |
          # For push events (auto-release), always release both
          # For workflow_dispatch, check the input
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            MODULE_INPUT="${{ inputs.module }}"
            if [ "$MODULE_INPUT" == "both" ] || [ "$MODULE_INPUT" == "${{ matrix.module }}" ]; then
              echo "enabled=true" >> $GITHUB_OUTPUT
            else
              echo "enabled=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Skip if not enabled
        if: steps.should_run.outputs.enabled != 'true'
        run: echo "Skipping ${{ matrix.module }}"

      - name: Checkout
        if: steps.should_run.outputs.enabled == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download bundled spec
        if: steps.should_run.outputs.enabled == 'true'
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec

      - name: Setup tools with mise
        if: steps.should_run.outputs.enabled == 'true'
        uses: jdx/mise-action@v3

      - name: Setup Gradle cache
        if: steps.should_run.outputs.enabled == 'true'
        uses: gradle/actions/setup-gradle@v5

      - name: Calculate version
        if: steps.should_run.outputs.enabled == 'true'
        id: version
        run: |
          # Read API version from spec (e.g., "1.0.0" -> "1.0")
          API_VERSION=$(grep -E '^\s*version:' epistola-api.yaml | head -1 | sed -E 's/.*version:\s*["'"'"']?([0-9]+\.[0-9]+)\.[0-9]+["'"'"']?.*/\1/')
          echo "api_version=${API_VERSION}" >> $GITHUB_OUTPUT

          # Find highest existing patch version for this artifact and API version
          LATEST_TAG=$(git tag -l "${{ matrix.artifact_id }}-v${API_VERSION}.*" | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            PATCH_VERSION=0
          else
            # Extract patch from tag like "client-spring3-restclient-v1.0.3" -> "3"
            LATEST_PATCH=$(echo "$LATEST_TAG" | sed -E 's/.*-v[0-9]+\.[0-9]+\.([0-9]+)/\1/')
            PATCH_VERSION=$((LATEST_PATCH + 1))
          fi

          FULL_VERSION="${API_VERSION}.${PATCH_VERSION}"
          echo "patch_version=${PATCH_VERSION}" >> $GITHUB_OUTPUT
          echo "full_version=${FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "Releasing version: ${FULL_VERSION}"

      - name: Build and test
        if: steps.should_run.outputs.enabled == 'true'
        working-directory: ${{ matrix.module }}
        run: ./gradlew build -PpatchVersion=${{ steps.version.outputs.patch_version }}

      - name: Publish to Maven Central
        if: steps.should_run.outputs.enabled == 'true'
        working-directory: ${{ matrix.module }}
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.OSSRH_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.OSSRH_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_PRIVATE_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSPHRASE }}
        run: ./gradlew publishToMavenCentral -PpatchVersion=${{ steps.version.outputs.patch_version }}

      - name: Create GitHub Release
        if: steps.should_run.outputs.enabled == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.artifact_id }}-v${{ steps.version.outputs.full_version }}
          name: ${{ matrix.artifact_id }} v${{ steps.version.outputs.full_version }}
          files: openapi.yaml
          body: |
            ## ${{ matrix.artifact_id }} v${{ steps.version.outputs.full_version }}

            ### Maven Coordinates
            ```xml
            <dependency>
                <groupId>app.epistola.contract</groupId>
                <artifactId>${{ matrix.artifact_id }}</artifactId>
                <version>${{ steps.version.outputs.full_version }}</version>
            </dependency>
            ```

            ### Gradle (Kotlin DSL)
            ```kotlin
            implementation("app.epistola.contract:${{ matrix.artifact_id }}:${{ steps.version.outputs.full_version }}")
            ```

            ### OpenAPI Spec
            The bundled OpenAPI specification is attached as `openapi.yaml`.
          draft: false
          prerelease: false
          generate_release_notes: true
