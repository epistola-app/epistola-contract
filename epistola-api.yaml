openapi: 3.1.0
info:
  title: Epistola API
  description: |
    Document template management API for Epistola Suite.

    ## Versioning
    This API uses header-based versioning via the Accept header.
    Use `application/vnd.epistola.v1+json` for API version 1.

    ## Authentication
    The API supports two authentication methods:
    - **OAuth 2.0 JWT** (recommended): Use Client Credentials flow to obtain an access token
    - **API Key**: Static key in `X-API-Key` header for environments without an IdP

    See the [Authentication Guide](/docs/auth.md) for details.

    ## Authorization
    Access is controlled via roles (`reader`, `editor`, `generator`, `admin`) and
    tenant permissions. JWT claims or API key configuration determine which
    tenants a client can access.
  version: 0.1.0
  contact:
    name: Epistola Team
  license:
    name: EUPL-1.2
    identifier: EUPL-1.2

servers:
  - url: /api
    description: Base API path

tags:
  - name: Tenants
    description: Multi-tenant management operations
  - name: Templates
    description: Document template operations
  - name: Themes
    description: Reusable style collections for templates
  - name: Environments
    description: Tenant environment configuration (staging, production, etc.)
  - name: Variants
    description: Template variant operations (language, brand variations)
  - name: Versions
    description: Template version lifecycle (draft, publish, archive)
  - name: Generation
    description: Asynchronous document generation operations

# Global security - either JWT or API Key is valid (OR logic via separate array entries)
security:
  - bearerAuth: []
  - apiKeyAuth: []

paths:
  # Tenants
  /tenants:
    $ref: './spec/paths/tenants.yaml#/tenants'
  /tenants/{tenantId}:
    $ref: './spec/paths/tenants.yaml#/tenants-id'

  # Themes
  /tenants/{tenantId}/themes:
    $ref: './spec/paths/themes.yaml#/themes'
  /tenants/{tenantId}/themes/{themeId}:
    $ref: './spec/paths/themes.yaml#/themes-id'

  # Environments
  /tenants/{tenantId}/environments:
    $ref: './spec/paths/environments.yaml#/environments'
  /tenants/{tenantId}/environments/{environmentId}:
    $ref: './spec/paths/environments.yaml#/environments-id'

  # Templates
  /tenants/{tenantId}/templates:
    $ref: './spec/paths/templates.yaml#/templates'
  /tenants/{tenantId}/templates/{templateId}:
    $ref: './spec/paths/templates.yaml#/templates-id'
  /tenants/{tenantId}/templates/{templateId}/validate:
    $ref: './spec/paths/templates.yaml#/template-validate'

  # Variants
  /tenants/{tenantId}/templates/{templateId}/variants:
    $ref: './spec/paths/variants.yaml#/variants'
  /tenants/{tenantId}/templates/{templateId}/variants/{variantId}:
    $ref: './spec/paths/variants.yaml#/variants-id'
  /tenants/{tenantId}/templates/{templateId}/variants/{variantId}/draft:
    $ref: './spec/paths/variants.yaml#/variant-draft'
  /tenants/{tenantId}/templates/{templateId}/variants/{variantId}/activations:
    $ref: './spec/paths/variants.yaml#/variant-activations'
  /tenants/{tenantId}/templates/{templateId}/variants/{variantId}/activations/{environmentId}:
    $ref: './spec/paths/variants.yaml#/variant-activation-env'
  /tenants/{tenantId}/templates/{templateId}/variants/{variantId}/active:
    $ref: './spec/paths/variants.yaml#/variant-active'

  # Versions
  /tenants/{tenantId}/templates/{templateId}/variants/{variantId}/versions:
    $ref: './spec/paths/versions.yaml#/versions'
  /tenants/{tenantId}/templates/{templateId}/variants/{variantId}/versions/{versionId}:
    $ref: './spec/paths/versions.yaml#/versions-id'
  /tenants/{tenantId}/templates/{templateId}/variants/{variantId}/versions/{versionId}/publish:
    $ref: './spec/paths/versions.yaml#/version-publish'
  /tenants/{tenantId}/templates/{templateId}/variants/{variantId}/versions/{versionId}/archive:
    $ref: './spec/paths/versions.yaml#/version-archive'

  # Document Generation
  /tenants/{tenantId}/documents/generate:
    $ref: './spec/paths/generation.yaml#/generate-document'
  /tenants/{tenantId}/documents/generate/batch:
    $ref: './spec/paths/generation.yaml#/generate-batch'
  /tenants/{tenantId}/documents/jobs:
    $ref: './spec/paths/generation.yaml#/jobs'
  /tenants/{tenantId}/documents/jobs/{requestId}:
    $ref: './spec/paths/generation.yaml#/job-detail'
  /tenants/{tenantId}/documents:
    $ref: './spec/paths/generation.yaml#/documents'
  /tenants/{tenantId}/documents/{documentId}:
    $ref: './spec/paths/generation.yaml#/document-detail'

components:
  schemas:
    # Tenant schemas
    TenantDto:
      $ref: './spec/components/schemas/tenants.yaml#/TenantDto'
    CreateTenantRequest:
      $ref: './spec/components/schemas/tenants.yaml#/CreateTenantRequest'
    UpdateTenantRequest:
      $ref: './spec/components/schemas/tenants.yaml#/UpdateTenantRequest'
    TenantListResponse:
      $ref: './spec/components/schemas/tenants.yaml#/TenantListResponse'

    # Theme schemas
    ThemeDto:
      $ref: './spec/components/schemas/themes.yaml#/ThemeDto'
    DocumentStylesDto:
      $ref: './spec/components/schemas/themes.yaml#/DocumentStylesDto'
    PageSettingsDto:
      $ref: './spec/components/schemas/themes.yaml#/PageSettingsDto'
    MarginsDto:
      $ref: './spec/components/schemas/themes.yaml#/MarginsDto'
    CreateThemeRequest:
      $ref: './spec/components/schemas/themes.yaml#/CreateThemeRequest'
    UpdateThemeRequest:
      $ref: './spec/components/schemas/themes.yaml#/UpdateThemeRequest'
    ThemeListResponse:
      $ref: './spec/components/schemas/themes.yaml#/ThemeListResponse'

    # Environment schemas
    EnvironmentDto:
      $ref: './spec/components/schemas/environments.yaml#/EnvironmentDto'
    CreateEnvironmentRequest:
      $ref: './spec/components/schemas/environments.yaml#/CreateEnvironmentRequest'
    UpdateEnvironmentRequest:
      $ref: './spec/components/schemas/environments.yaml#/UpdateEnvironmentRequest'
    EnvironmentListResponse:
      $ref: './spec/components/schemas/environments.yaml#/EnvironmentListResponse'

    # Template schemas
    TemplateDto:
      $ref: './spec/components/schemas/templates.yaml#/TemplateDto'
    TemplateSummaryDto:
      $ref: './spec/components/schemas/templates.yaml#/TemplateSummaryDto'
    CreateTemplateRequest:
      $ref: './spec/components/schemas/templates.yaml#/CreateTemplateRequest'
    UpdateTemplateRequest:
      $ref: './spec/components/schemas/templates.yaml#/UpdateTemplateRequest'
    TemplateListResponse:
      $ref: './spec/components/schemas/templates.yaml#/TemplateListResponse'
    DataExampleDto:
      $ref: './spec/components/schemas/templates.yaml#/DataExampleDto'

    # Validation schemas
    ValidateTemplateDataRequest:
      $ref: './spec/components/schemas/validation.yaml#/ValidateTemplateDataRequest'
    TemplateDataValidationResult:
      $ref: './spec/components/schemas/validation.yaml#/TemplateDataValidationResult'
    TemplateDataValidationError:
      $ref: './spec/components/schemas/validation.yaml#/TemplateDataValidationError'

    # Variant schemas
    VariantDto:
      $ref: './spec/components/schemas/variants.yaml#/VariantDto'
    VariantSummaryDto:
      $ref: './spec/components/schemas/variants.yaml#/VariantSummaryDto'
    CreateVariantRequest:
      $ref: './spec/components/schemas/variants.yaml#/CreateVariantRequest'
    UpdateVariantRequest:
      $ref: './spec/components/schemas/variants.yaml#/UpdateVariantRequest'
    VariantListResponse:
      $ref: './spec/components/schemas/variants.yaml#/VariantListResponse'
    ActivationDto:
      $ref: './spec/components/schemas/variants.yaml#/ActivationDto'
    SetActivationRequest:
      $ref: './spec/components/schemas/variants.yaml#/SetActivationRequest'
    ActivationListResponse:
      $ref: './spec/components/schemas/variants.yaml#/ActivationListResponse'

    # Version schemas
    VersionDto:
      $ref: './spec/components/schemas/versions.yaml#/VersionDto'
    VersionSummaryDto:
      $ref: './spec/components/schemas/versions.yaml#/VersionSummaryDto'
    UpdateDraftRequest:
      $ref: './spec/components/schemas/versions.yaml#/UpdateDraftRequest'
    VersionListResponse:
      $ref: './spec/components/schemas/versions.yaml#/VersionListResponse'

    # Generation schemas
    GenerateDocumentRequest:
      $ref: './spec/components/schemas/generation.yaml#/GenerateDocumentRequest'
    BatchGenerationItem:
      $ref: './spec/components/schemas/generation.yaml#/BatchGenerationItem'
    GenerateBatchRequest:
      $ref: './spec/components/schemas/generation.yaml#/GenerateBatchRequest'
    GenerationJobResponse:
      $ref: './spec/components/schemas/generation.yaml#/GenerationJobResponse'
    DocumentGenerationItemDto:
      $ref: './spec/components/schemas/generation.yaml#/DocumentGenerationItemDto'
    DocumentGenerationJobDto:
      $ref: './spec/components/schemas/generation.yaml#/DocumentGenerationJobDto'
    GenerationJobDetail:
      $ref: './spec/components/schemas/generation.yaml#/GenerationJobDetail'
    GenerationJobListResponse:
      $ref: './spec/components/schemas/generation.yaml#/GenerationJobListResponse'
    DocumentDto:
      $ref: './spec/components/schemas/generation.yaml#/DocumentDto'
    DocumentListResponse:
      $ref: './spec/components/schemas/generation.yaml#/DocumentListResponse'

    # Error schemas
    ErrorResponse:
      $ref: './spec/components/responses/errors.yaml#/ErrorResponse'
    ValidationErrorResponse:
      $ref: './spec/components/responses/errors.yaml#/ValidationErrorResponse'
    FieldError:
      $ref: './spec/components/responses/errors.yaml#/FieldError'

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        OAuth 2.0 access token obtained via Client Credentials flow.
        Supports Keycloak, Azure AD, or any OAuth 2.0 compliant IdP.

        Required JWT claims:
        - `roles`: Array of roles (reader, editor, generator, manager, tenant_control)
        - `allowed_tenants`: Array of tenant slugs or ["*"] for all tenants

    apiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        Static API key for environments without an IdP.
        Keys are issued by administrators and stored server-side
        with associated roles and tenant access permissions.
